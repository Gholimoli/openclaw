name: Upstream Sync PR

on:
  schedule:
    # 3x/week: keeps the fork current without noisy constant churn.
    - cron: "17 5 * * 1,3,5"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: upstream-sync-pr
  cancel-in-progress: false

jobs:
  sync:
    # This workflow is meant for forks.
    if: ${{ github.event.repository.fork }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      BASE_BRANCH: main
      SYNC_BRANCH: chore/sync-upstream-main
      UPSTREAM_REPO: https://github.com/openclaw/openclaw.git
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Merge upstream into sync branch
        id: sync
        run: |
          set -euo pipefail

          echo "has_updates=false" >> "$GITHUB_OUTPUT"
          echo "has_conflicts=false" >> "$GITHUB_OUTPUT"

          git remote remove upstream 2>/dev/null || true
          git remote add upstream "$UPSTREAM_REPO"
          git fetch --no-tags origin "$BASE_BRANCH"
          git fetch --no-tags upstream "$BASE_BRANCH"

          read -r local_only upstream_only < <(git rev-list --left-right --count "origin/$BASE_BRANCH...upstream/$BASE_BRANCH")
          echo "local_only=$local_only" >> "$GITHUB_OUTPUT"
          echo "upstream_only=$upstream_only" >> "$GITHUB_OUTPUT"

          if [ "$upstream_only" -eq 0 ]; then
            echo "Fork already in sync with upstream."
            exit 0
          fi

          git checkout -B "$SYNC_BRANCH" "origin/$BASE_BRANCH"

          set +e
          git merge --no-ff --no-edit "upstream/$BASE_BRANCH"
          merge_status=$?
          set -e

          if [ "$merge_status" -ne 0 ]; then
            {
              echo "has_conflicts=true"
              echo "conflict_files<<EOF"
              git diff --name-only --diff-filter=U
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            git merge --abort || true
            exit 0
          fi

          # Keep this fork's workflow files authoritative.
          # GitHub Actions' default token cannot push workflow-file updates unless elevated.
          git restore --source "origin/$BASE_BRANCH" --staged --worktree .github/workflows || true

          if git diff --quiet "origin/$BASE_BRANCH...HEAD"; then
            echo "No sync delta remains after applying fork keep rules."
            exit 0
          fi

          git push --force-with-lease origin "$SYNC_BRANCH"
          echo "has_updates=true" >> "$GITHUB_OUTPUT"

      - name: Create or update sync PR
        if: steps.sync.outputs.has_updates == 'true'
        run: |
          set -euo pipefail

          title="chore: sync upstream ${BASE_BRANCH}"
          commit_summary="$(git log --oneline --no-merges "origin/${BASE_BRANCH}..${SYNC_BRANCH}" | head -n 80)"
          if [ -z "$commit_summary" ]; then
            commit_summary="(no non-merge commits listed)"
          fi

          body="$(cat <<EOF
          Automated upstream sync from \`openclaw/openclaw:${BASE_BRANCH}\`.

          - Workflow run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
          - Generated at: $(date -u '+%Y-%m-%d %H:%M UTC')
          - Upstream-only commits detected: ${{ steps.sync.outputs.upstream_only }}
          - Local-only commits already on fork base: ${{ steps.sync.outputs.local_only }}

          Safety:
          - This workflow never merges into \`${BASE_BRANCH}\` automatically.
          - Review and merge manually after required checks are green.

          Included commits:
          \`\`\`
          ${commit_summary}
          \`\`\`
          EOF
          )"

          pr_number="$(gh pr list --head "$SYNC_BRANCH" --base "$BASE_BRANCH" --state open --json number --jq '.[0].number // empty')"
          if [ -n "$pr_number" ]; then
            gh pr edit "$pr_number" --title "$title" --body "$body"
          else
            gh pr create --title "$title" --body "$body" --base "$BASE_BRANCH" --head "$SYNC_BRANCH"
          fi

      - name: Close stale sync PR when no upstream delta
        if: steps.sync.outputs.has_updates != 'true' && steps.sync.outputs.has_conflicts != 'true'
        run: |
          set -euo pipefail
          pr_number="$(gh pr list --head "$SYNC_BRANCH" --base "$BASE_BRANCH" --state open --json number --jq '.[0].number // empty')"
          if [ -n "$pr_number" ]; then
            gh pr close "$pr_number" --comment "Auto-closing: fork is currently in sync with upstream ${BASE_BRANCH}."
          fi

      - name: Report merge conflicts
        if: steps.sync.outputs.has_conflicts == 'true'
        run: |
          set -euo pipefail

          issue_title="Upstream sync conflict on ${BASE_BRANCH}"
          issue_body="$(cat <<EOF
          Automated upstream sync could not be applied cleanly.

          - Upstream repository: \`openclaw/openclaw\`
          - Base branch: \`${BASE_BRANCH}\`
          - Sync branch: \`${SYNC_BRANCH}\`
          - Workflow run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}

          Conflicting files:
          \`\`\`
          ${{ steps.sync.outputs.conflict_files }}
          \`\`\`

          Action required:
          1. Create/update \`${SYNC_BRANCH}\` locally from \`${BASE_BRANCH}\`.
          2. Merge \`upstream/${BASE_BRANCH}\` manually and resolve conflicts.
          3. Push \`${SYNC_BRANCH}\` and continue with the sync PR.
          EOF
          )"

          issue_number="$(gh issue list --state open --search "\"${issue_title}\" in:title" --json number --jq '.[0].number // empty')"
          if [ -n "$issue_number" ]; then
            gh issue comment "$issue_number" --body "$issue_body"
          else
            gh issue create --title "$issue_title" --body "$issue_body"
          fi
