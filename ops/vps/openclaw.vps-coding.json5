// Secure VPS config focused on deterministic coding automation.
// Location: ~/.openclaw/openclaw.json (or $OPENCLAW_STATE_DIR/openclaw.json)
{
  // Keep the gateway private. Use Tailscale to access the Control UI.
  gateway: {
    mode: "local",
    bind: "loopback", // do not expose publicly
    port: 18789,
    auth: {
      mode: "token",
      token: "${OPENCLAW_GATEWAY_TOKEN}",
    },
    // Harden /tools/invoke: keep the default hard-deny list and add more.
    tools: {
      deny: ["gateway", "sessions_send", "sessions_spawn", "whatsapp_login"],
    },
  },

  // Environment: put secrets in ~/.openclaw/.env so the daemon can read them.
  env: {
    // Optional: import missing vars from login shell (useful on VPS if you manage env in ~/.profile).
    shellEnv: { enabled: false },
  },

  // Telegram: owner-allowlisted DMs, groups disabled, and block channel-initiated config writes.
  channels: {
    telegram: {
      enabled: true,
      botToken: "${TELEGRAM_BOT_TOKEN}",
      // For single-operator setups, prefer allowlisting your numeric Telegram user ID.
      // This avoids pairing-code friction while keeping DMs locked down.
      // Find your ID by messaging the bot once, then check:
      //   openclaw channels status --probe
      dmPolicy: "allowlist",
      allowFrom: ["${TELEGRAM_OWNER_ID}"],
      groupPolicy: "disabled",
      configWrites: false,
      // Never stream partial drafts to Telegram. Only send final replies.
      streamMode: "off",
    },
  },

  // Secure DM mode so multi-user accidents don't cross-contaminate context.
  session: {
    dmScope: "per-channel-peer",
  },

  // Enable bundled plugins explicitly.
  plugins: {
    entries: {
      work: {
        enabled: true,
        config: {
          // Prefer absolute lobsterPath in production (reduces PATH hijack risk).
          // lobsterPath: "/usr/local/bin/lobster",
          workRoot: "~/work",
          defaultBase: "main",
          coderSessionKey: "agent:coder:main",
          maxFixLoops: 3,
          timeoutMs: 1800000, // 30m
        },
      },
    },
  },

  // Global tool baseline: keep it tight; let the workflow run tools via /tools/invoke
  // against the coder agent session, not your main chat surface.
  tools: {
    profile: "minimal",
    elevated: { enabled: false },
    // Speech-to-text: enable audio transcription for inbound voice notes.
    // Recommendation (privacy/cost): prefer local Whisper.cpp, fall back to a provider if needed.
    media: {
      audio: {
        enabled: true,
        maxBytes: 20971520, // 20MB
        timeoutSeconds: 120,
        models: [
          // Local Whisper.cpp (install whisper-cli and set WHISPER_CPP_MODEL in ~/.openclaw/.env)
          {
            type: "cli",
            command: "whisper-cli",
            args: [
              "-m",
              "${WHISPER_CPP_MODEL}",
              "-otxt",
              "-of",
              "{{OutputBase}}",
              "-np",
              "-nt",
              "{{MediaPath}}",
            ],
          },
          // Fallback to an OpenAI-compatible provider if local STT is unavailable.
          { provider: "openai", model: "gpt-4o-mini-transcribe" },
        ],
      },
    },
  },

  // Voice replies live at the top-level (not per-agent). Keep it gated to avoid voice spam.
  messages: {
    tts: {
      // - tagged: only reply with voice when the model emits [[tts:...]]
      // - inbound: reply with voice only after you send a voice note
      // - always: reply with voice for every message (not recommended)
      auto: "tagged",
      provider: "openai",
      openai: {
        model: "gpt-4o-mini-tts",
        voice: "alloy",
      },
    },
  },

  agents: {
    list: [
      {
        id: "main",
        workspace: "~/.openclaw/workspace/main",
        // Orchestrator only: no shell, no browser, no file mutation.
        // Allow it to spawn limited sub-agent runs into worker agents.
        subagents: { allowAgents: ["coder", "power"] },
        tools: {
          profile: "minimal",
          deny: [
            "exec",
            "process",
            "browser",
            "write",
            "edit",
            "apply_patch",
            "canvas",
            "nodes",
            "cron",
            "gateway",
            "sessions_spawn",
            "sessions_send",
          ],
        },
      },
      {
        id: "coder",
        workspace: "~/work",
        // Run all tool execution for this agent in Docker.
        sandbox: {
          mode: "all",
          scope: "agent",
          workspaceAccess: "rw",
          docker: {
            image: "openclaw-sandbox-coder:bookworm",
            network: "bridge",
            readOnlyRoot: false,
            user: "1000:1000",
            env: {
              LANG: "C.UTF-8",
              // Auth for CLI tools inside the sandbox:
              GH_TOKEN: "${GH_TOKEN}",
              OPENAI_API_KEY: "${OPENAI_API_KEY}",
              GEMINI_API_KEY: "${GEMINI_API_KEY}",
              CODERABBIT_API_KEY: "${CODERABBIT_API_KEY}",
              // Git identity (required for commits):
              GIT_AUTHOR_NAME: "${GIT_AUTHOR_NAME}",
              GIT_AUTHOR_EMAIL: "${GIT_AUTHOR_EMAIL}",
              GIT_COMMITTER_NAME: "${GIT_AUTHOR_NAME}",
              GIT_COMMITTER_EMAIL: "${GIT_AUTHOR_EMAIL}",
            },
            // Keep sandbox bounded.
            pidsLimit: 256,
            memory: "4g",
            cpus: 2,
          },
        },
        // Allow only what the workflow needs inside sandbox.
        tools: {
          profile: "minimal",
          allow: ["exec", "process", "read", "write", "edit", "apply_patch"],
          deny: [
            "browser",
            "canvas",
            "nodes",
            "cron",
            "gateway",
            "sessions_spawn",
            "sessions_send",
          ],
        },
      },
      {
        // "Super powers" agent: browser + shell access with strict approvals/allowlists.
        // Keep file mutation tools disabled; use approvals-gated exec for any side effects.
        id: "power",
        workspace: "~/.openclaw/workspace/power",
        tools: {
          profile: "minimal",
          allow: ["browser", "exec", "process", "read"],
          deny: [
            "write",
            "edit",
            "apply_patch",
            "canvas",
            "nodes",
            "cron",
            "gateway",
            "sessions_spawn",
            "sessions_send",
          ],
        },
      },
      {
        id: "ops",
        workspace: "~/.openclaw/workspace/ops",
        tools: { profile: "minimal", deny: ["exec", "process"] },
      },
    ],
  },

  // Forward exec approvals to your Telegram DM (for the power agent only).
  approvals: {
    exec: {
      enabled: true,
      mode: "targets",
      agentFilter: ["power"],
      targets: [{ channel: "telegram", to: "${TELEGRAM_OWNER_ID}" }],
    },
  },
}
